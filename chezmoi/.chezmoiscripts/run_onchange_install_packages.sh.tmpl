#!/bin/sh
set -e

echo "Running intelligent system package installer..."

{{- /* 定义一个辅助函数来检查包是否已安装 */}}
is_installed() {
  command -v "$1" >/dev/null 2>&1
}

{{- if eq .chezmoi.os "darwin" -}}
{{- /* --- macOS --- */}}

# 1. 安装 Homebrew (幂等)
if ! is_installed brew; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

echo "Updating Homebrew..."
brew update

# 2. 准备包列表
PACKAGES_TO_INSTALL="{{ .packages.common | join " " }} {{ .packages.darwin | join " " }}"
# 处理包名差异: fd-find 在 brew 中是 fd
PACKAGES_TO_INSTALL=$(echo "$PACKAGES_TO_INSTALL" | sed 's/fd-find/fd/g')

PACKAGES_TO_DARWIN_TAP="{{ .packages.darwin_taps | join " " }}"

echo "Tapping additional Homebrew repositories if needed..."
for tap in $PACKAGES_TO_DARWIN_TAP; do
  if ! brew tap | grep -q "^$tap\$"; then
    echo "Tapping $tap..."
    brew tap "$tap"
  else
    echo "Tap $tap already exists."
  fi
done

echo "Installing packages with Homebrew: $PACKAGES_TO_INSTALL"
# 使用 for 循环来避免单个包失败导致整个命令中断，并提供更好的日志
for pkg in $PACKAGES_TO_INSTALL; do
  if brew list --versions "$pkg" >/dev/null; then
    echo "$pkg is already installed."
  else
    echo "Installing $pkg..."
    brew install "$pkg"
  fi
done

# 3. 处理特殊安装
echo "Handling special Homebrew installations..."

# universal-ctags with --HEAD
if ! brew list --versions universal-ctags >/dev/null; then
  echo "Installing universal-ctags from HEAD..."
  brew install --HEAD universal-ctags/universal-ctags/universal-ctags
else
  echo "universal-ctags is already installed."
fi

# fzf 安装后脚本
if [ -f "$(brew --prefix)/opt/fzf/install" ]; then
  echo "Running fzf post-install script..."
  if ! is_installed fzf; then
    echo "fzf is not installed, running install script..."
    {{- if eq .chezmoi.os "darwin" -}}
      PATH=$(brew --prefix)/opt/coreutils/libexec/gnubin:$PATH "$(brew --prefix)/opt/fzf/install" --all
    {{- else -}}
      "$(brew --prefix)/opt/fzf/install" --all
    {{- end }}
  else
    echo "fzf is already installed, skipping install script."
  fi
fi


{{- else if eq .chezmoi.os "linux" -}}
{{- /* --- Linux --- */}}

# 从 /etc/os-release 获取发行版 ID
DISTRO_ID={{ .chezmoi.osRelease.id | quote }}
COMMON_PACKAGES="{{ .packages.common | join " " }}"
DISTRO_PACKAGES=""
SNAP_PACKAGES=""
INSTALL_CMD=""
UPDATE_CMD=""

case "$DISTRO_ID" in
  "ubuntu"|"debian")
    UPDATE_CMD="sudo apt-get update"
    INSTALL_CMD="sudo apt-get install -y"
    DISTRO_PACKAGES="{{ .packages.linux.ubuntu | join " " }}"
    SNAP_PACKAGES="{{ .packages.linux.ubuntu_snap | join " " }}"
    # 包名差异处理 - 从 apt 包列表中移除 snap 包
    for snap_pkg in $SNAP_PACKAGES; do
      COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed "s/$snap_pkg//g")
    done
    ;;
  "fedora"|"centos")
    UPDATE_CMD="sudo dnf check-update"
    INSTALL_CMD="sudo dnf install -y"
    DISTRO_PACKAGES="{{ .packages.linux.fedora | join " " }}"
    # 包名差异处理
    COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/fd-find/fd/g')
    COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/bat/bat/g') # 在某些老版本CentOS可能叫 batcat
    ;;
  "alibaba" | "alinux")
      # For Enterprise Linux, we need to enable additional repositories first.
      echo "Configuring repositories for Enterprise Linux..."

      # 1. Install EPEL (Extra Packages for Enterprise Linux) repository
      # It provides many common packages that are not in the default repos.
      if ! dnf repolist | grep -q "epel"; then
        echo "Installing EPEL repository..."
        # alinux 3 is compatible with RHEL 8
        sudo dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
      fi

      # 2. Add the official GitHub CLI (gh) repository
      if ! command -v gh >/dev/null; then
          if ! dnf repolist | grep -q "gh-cli"; then
              echo "Adding GitHub CLI repository..."
              sudo dnf install -y 'dnf-command(config-manager)'
              sudo dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
              sudo rpm --import https://cli.github.com/packages/rpm/gh-cli-key.gpg
          fi
      fi

      # 3. Enable the CodeReady Builder (CRB) / PowerTools repository
      # This is needed for build dependencies and some packages like fcitx5
      echo "Enabling CRB (CodeReady Builder) repository..."
      sudo dnf config-manager --set-enabled crb

      UPDATE_CMD="sudo dnf check-update"
      INSTALL_CMD="sudo dnf install -y"
      DISTRO_PACKAGES="{{ .packages.linux.alibaba | join " " }}"

      # 4. Handle package name differences for alinux/EPEL
      # Note: fd-find is the package, but it creates the `fd` command.
      COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/fd-find/fd-find/g')
      # The package for bat is just `bat` in EPEL
      COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/bat/bat/g')
      # Package name is case-sensitive in EPEL
      COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/shellcheck/ShellCheck/g')

      # 5. Remove packages known to be unavailable in EPEL 8 to prevent errors
      # eza, dust, duf, and chroma are not packaged in the standard repos.
      # You would need to install these manually or via another method (e.g., brew).
      echo "Note: The following packages are not available in alinux/EPEL and will be skipped: eza, dust, duf, chroma"
      for pkg in eza dust duf chroma; do
        COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed "s/\b$pkg\b//g")
      done
      ;;
  "arch")
    UPDATE_CMD="sudo pacman -Syu --noconfirm"
    INSTALL_CMD="sudo pacman -S --noconfirm"
    DISTRO_PACKAGES="{{ .packages.linux.arch | join " " }}"
    # 包名差异处理
    COMMON_PACKAGES=$(echo "$COMMON_PACKAGES" | sed 's/fd-find/fd/g')
    ;;
  *)
    echo "Unsupported Linux distribution: $DISTRO_ID. Please install packages manually."
    exit 1
    ;;
esac

PACKAGES_TO_INSTALL="$COMMON_PACKAGES $DISTRO_PACKAGES"

if [ -z "$(echo $PACKAGES_TO_INSTALL | xargs)" ]; then
    echo "No packages to install for this distribution."
    exit 0
fi

echo "Updating package list for $DISTRO_ID..."
case "$DISTRO_ID" in
  "fedora"|"centos"|"alibaba"|"alinux")
    # dnf/yum 返回 100 表示有可用更新，这不是一个错误。
    $UPDATE_CMD || [ $? -eq 100 ]
    ;;
  *)
    # 对于 apt 和 pacman, 非 0 退出码通常表示真正的错误。
    $UPDATE_CMD
    ;;
esac

echo "Installing packages for $DISTRO_ID: $PACKAGES_TO_INSTALL"
$INSTALL_CMD $PACKAGES_TO_INSTALL

# Install snap packages for Ubuntu/Debian
case "$DISTRO_ID" in
  "ubuntu"|"debian")
    if [ -n "$SNAP_PACKAGES" ] && [ "$(echo $SNAP_PACKAGES | xargs)" != "" ]; then
      # 确保 snapd 已安装
      if ! is_installed snap; then
        echo "Installing snapd..."
        sudo apt-get install -y snapd
      fi

      echo "Installing snap packages: $SNAP_PACKAGES"
      for snap_pkg in $SNAP_PACKAGES; do
        if snap list | grep -q "^$snap_pkg "; then
          echo "$snap_pkg is already installed via snap."
        else
          echo "Installing $snap_pkg via snap..."
          sudo snap install "$snap_pkg"
        fi
      done
    fi
    ;;
esac


{{- else -}}
echo "Unsupported OS: {{ .chezmoi.os }}. Skipping package installation."
{{- end }}

echo "System package installation script finished."
